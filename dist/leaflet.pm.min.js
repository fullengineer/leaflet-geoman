L.PM=L.PM||{},L.Control.PMButton=L.Control.extend({options:{position:"topleft"},initialize:function(t){this._button={},this.setButton(t)},onAdd:function(t){this._map=t;var e=L.DomUtil.create("div","leaflet-control-button");return this._container=e,this._update(),this._container},onRemove:function(t){},setButton:function(t){var e={text:t.text,iconUrl:t.iconUrl,onClick:t.onClick,hideText:!!t.hideText,maxWidth:t.maxWidth||70,doToggle:t.doToggle,toggleStatus:!1};this._button=e,this._update()},getText:function(){return this._button.text},getIconUrl:function(){return this._button.iconUrl},destroy:function(){this._button={},this._update()},toggle:function(t){"boolean"==typeof t?this._button.toggleStatus=t:this._button.toggleStatus=!this._button.toggleStatus,this._update()},_update:function(){this._map&&(this._container.innerHTML="",this._makeButton(this._button))},_makeButton:function(t){var e=L.DomUtil.create("div","leaflet-buttons-control-button",this._container);t.toggleStatus&&L.DomUtil.addClass(e,"active");L.DomUtil.create("span","fa fa-stop",e);if(""!==t.text){L.DomUtil.create("br","",e);var i=L.DomUtil.create("span","leaflet-buttons-control-text",e),r=document.createTextNode(t.text);i.appendChild(r),t.hideText&&L.DomUtil.addClass(i,"leaflet-buttons-control-text-hide")}return L.DomEvent.addListener(e,"click",L.DomEvent.stop).addListener(e,"click",t.onClick,this).addListener(e,"click",this._clicked,this),L.DomEvent.disableClickPropagation(e),e},_clicked:function(){this._button.doToggle&&(this._button.toggleStatus?L.DomUtil.removeClass(this._container.childNodes[0],"active"):L.DomUtil.addClass(this._container.childNodes[0],"active"),this.toggle())}}),L.PM.LayerGroup=L.Class.extend({initialize:function(t){var e=this;this._layerGroup=t,this._layers=t.getLayers();for(var i=0;i<this._layers.length;i++)this._layers[i].on("edit",function(){e._layerGroup.fireEvent("edit")})},toggleEdit:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.toggleEdit()},enable:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.enable()},disable:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.disable()},enabled:function(){for(var t=!1,e=0;e<this._layers.length&&!(t=this._layers[e].pm.enabled());e++);return t}});var initLayerGroup=function(){this.pm=new L.PM.LayerGroup(this)};L.LayerGroup.addInitHook(initLayerGroup),L.PM.Poly=L.Class.extend({initialize:function(t){this._poly=t,this._enabled=!1},toggleEdit:function(){this.enabled()?this.disable():this.enable()},enable:function(){this.enabled()||(this._enabled=!0,this._markerGroup||(this._markerGroup=new L.LayerGroup,this._initMarkers()),this._poly._map.addLayer(this._markerGroup))},enabled:function(){return this._enabled},disable:function(){this._enabled=!1,this._poly._map.removeLayer(this._markerGroup)},_initMarkers:function(){this._markers=[];for(var t=this._poly._latlngs[0],e=0;e<t.length;e++){var i=this._createMarker(t[e],e);this._markers.push(i)}for(var r=0;r<t.length;r++){var a=r+1>=t.length?0:r+1;this._createMiddleMarker(this._markers[r],this._markers[a])}},_createMarker:function(t,e){var i=new L.Marker(t,{draggable:!0,icon:L.divIcon({className:"marker-icon"})});return i._origLatLng=t,i._index=e,i.on("drag",this._onMarkerDrag,this),i.on("dragend",this._onMarkerDragEnd,this),i.on("contextmenu",this._removeMarker,this),this._markerGroup.addLayer(i),i},_createMiddleMarker:function(t,e){var i=this,r=this._calcMiddleLatLng(t,e),a=this._createMarker(r);a.setOpacity(.7),t._middleMarkerRight=a,e._middleMarkerLeft=a,a.on("dragstart",function(){i._addMarker(a,t,e)}),a.on("click",function(){i._addMarker(a,t,e)})},_addMarker:function(t,e,i){t.setOpacity(1),t.off("dragstart"),t.off("click");var r=t.getLatLng(),a=this._poly._latlngs[0],n=e._index+1;a.splice(n,0,r),t._origLatLng=a[n],this._markers.splice(n,0,t);for(var o=0;o<this._markers.length;o++)this._markers[o]._index=o;this._createMiddleMarker(e,t),this._createMiddleMarker(t,i)},_removeMarker:function(t){var e=t.target;if(void 0!==e._index){var i=this._poly._latlngs[0],r=e._index;i.splice(r,1),this._poly.redraw(),this._markerGroup.removeLayer(e._middleMarkerLeft),this._markerGroup.removeLayer(e._middleMarkerRight),this._markerGroup.removeLayer(e);var a=0>r-1?this._markers.length-1:r-1,n=r+1>=this._markers.length?0:r+1,o=this._markers[a],s=this._markers[n];this._createMiddleMarker(o,s),this._markers.splice(r,1);for(var l=0;l<this._markers.length;l++)this._markers[l]._index=l;this._fireEdit()}},_onMarkerDrag:function(t){var e=t.target,i=e._index+1>=this._markers.length?0:e._index+1,r=e._index-1<0?this._markers.length-1:e._index-1;L.extend(e._origLatLng,e._latlng),this._poly.redraw();var a=this._calcMiddleLatLng(e,this._markers[i]);e._middleMarkerRight.setLatLng(a);var n=this._calcMiddleLatLng(e,this._markers[r]);e._middleMarkerLeft.setLatLng(n)},_onMarkerDragEnd:function(t){t.target;this._fireEdit()},_fireEdit:function(){this._poly.edited=!0,this._poly.fireEvent("edit")},_calcMiddleLatLng:function(t,e){var i=this._poly._map,r=i.project(t.getLatLng()),a=i.project(e.getLatLng()),n=i.unproject(r._add(a)._divideBy(2));return n}});var initPolygon=function(){this.pm=new L.PM.Poly(this)};L.Polygon.addInitHook(initPolygon);