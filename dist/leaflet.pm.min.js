L.PM=L.PM||{initialize:function(){var t=function(){this.pm=new L.PM.Edit.LayerGroup(this)};L.LayerGroup.addInitHook(t);var e=function(){this.pm=new L.PM.Edit.Poly(this)};L.Polygon.addInitHook(e);var i=function(){this.pm=new L.PM.Draw(this),console.log(this)};L.Map.addInitHook(i)},Edit:{}},L.PM.initialize(),L.PM.Draw=L.Class.extend({initialize:function(t){var e=this;this._map=t,this.shapes=["Poly"];for(var i=0;i<this.shapes.length;i++){var n=e.shapes[i];e[n]=new L.PM.Draw[n](e._map)}},enableDraw:function(t){this[t].enable()},disableDraw:function(t){this[t].disable()},addControls:function(){for(var t=this,e=0;e<this.shapes.length;e++){var i=t.shapes[e];t[i].addButton()}}}),L.Control.PMButton=L.Control.extend({options:{position:"topleft"},initialize:function(t){this._button={},this.setButton(t)},onAdd:function(t){this._map=t;var e=L.DomUtil.create("div","leaflet-control-button");return this._container=e,this._makeButton(this._button),this._container},onRemove:function(t){},setButton:function(t){var e={iconUrl:t.iconUrl,onClick:t.onClick,afterClick:t.afterClick,doToggle:t.doToggle,toggleStatus:t.toggleStatus};this._button=e},getText:function(){return this._button.text},getIconUrl:function(){return this._button.iconUrl},destroy:function(){this._button={},this._update()},toggle:function(t){"boolean"==typeof t?this._button.toggleStatus=t:this._button.toggleStatus=!this._button.toggleStatus},toggled:function(){return this._button.toggleStatus},onCreate:function(){this.toggle(!1)},_makeButton:function(t){var e=L.DomUtil.create("div","leaflet-buttons-control-button",this._container);t.toggleStatus&&L.DomUtil.addClass(e,"active");var i=L.DomUtil.create("img","control-icon",e);return i.setAttribute("src",t.iconUrl),L.DomEvent.addListener(e,"click",t.onClick,this).addListener(e,"click",this._clicked,this).addListener(e,"click",t.afterClick,this),L.DomEvent.disableClickPropagation(e),e},_clicked:function(){this._button.doToggle&&(this._button.toggleStatus?L.DomUtil.removeClass(this._container.childNodes[0],"active"):L.DomUtil.addClass(this._container.childNodes[0],"active"),this.toggle())}}),L.PM.Draw.Poly=L.PM.Draw.extend({initialize:function(t){this._map=t},enable:function(t){this._layerGroup=new L.LayerGroup,this._layerGroup.addTo(this._map),this._polyline=L.polyline([],{color:"red"}),this._layerGroup.addLayer(this._polyline),this._hintline=L.polyline([],{color:"red",dashArray:[5,5]}),this._layerGroup.addLayer(this._hintline),this._map._container.style.cursor="crosshair",this._map.on("click",this._createPolygonPoint,this),this._map.on("mousemove",this._syncHintLine,this),this._map.fireEvent("pm:drawstart")},disable:function(){this._map._container.style.cursor="default",this._map.off("click",this._createPolygonPoint),this._map.off("mousemove",this._syncHintLine),this._map.removeLayer(this._layerGroup),this._map.fireEvent("pm:drawend")},addButton:function(t){var e=this,i={iconUrl:"assets/icons/polygon.png",onClick:function(){},afterClick:function(t){this.toggled()?e.enable():e.disable()},doToggle:!0,toggleStatus:!1};return this._drawButton=new L.Control.PMButton(i).addTo(this._map),this._map.on("pm:drawstart",function(){e._drawButton.toggled()||e._drawButton._clicked()}),this._map.on("pm:drawend",function(){e._drawButton.toggled()&&e._drawButton._clicked()}),this._drawButton},_syncHintLine:function(t){var e=this._polyline.getLatLngs();if(e.length>0){var i=e[e.length-1];this._hintline.setLatLngs([i,t.latlng])}},_createPolygonPoint:function(t){var e=0===this._polyline.getLatLngs().length?!0:!1;this._polyline.addLatLng(t.latlng),this._createMarker(t.latlng,e),this._hintline.setLatLngs([t.latlng,t.latlng])},_finishPolygon:function(){var t=this._polyline.getLatLngs(),e=L.polygon(t).addTo(this._map);e.pm.toggleEdit(),this.disable(),this._map.fireEvent("pm:create",e)},_createMarker:function(t,e){var i=new L.Marker(t,{draggable:!1,icon:L.divIcon({className:"marker-icon"})});return this._layerGroup.addLayer(i),e&&i.on("click",this._finishPolygon,this),i}}),L.PM.Edit.Poly=L.Class.extend({initialize:function(t){this._poly=t,this._enabled=!1},toggleEdit:function(){this.enabled()?this.disable():this.enable()},enable:function(){var t=this;this.enabled()||(this._enabled=!0,this._markerGroup||(this._markerGroup=new L.LayerGroup,this._initMarkers()),this._poly._map.addLayer(this._markerGroup),this._poly.on("remove",function(){t.disable()}))},enabled:function(){return this._enabled},disable:function(){this._enabled=!1,this._poly._map.removeLayer(this._markerGroup)},_initMarkers:function(){this._markers=[];for(var t=this._poly._latlngs[0],e=0;e<t.length;e++){var i=this._createMarker(t[e],e);this._markers.push(i)}for(var n=0;n<t.length;n++){var r=n+1>=t.length?0:n+1;this._createMiddleMarker(this._markers[n],this._markers[r])}},_createMarker:function(t,e){var i=new L.Marker(t,{draggable:!0,icon:L.divIcon({className:"marker-icon"})});return i._origLatLng=t,i._index=e,i.on("drag",this._onMarkerDrag,this),i.on("dragend",this._onMarkerDragEnd,this),i.on("contextmenu",this._removeMarker,this),this._markerGroup.addLayer(i),i},_createMiddleMarker:function(t,e){var i=this,n=this._calcMiddleLatLng(t,e),r=this._createMarker(n),a=L.divIcon({className:"marker-icon marker-icon-middle"});r.setIcon(a),t._middleMarkerRight=r,e._middleMarkerLeft=r,r.on("dragstart",function(){i._addMarker(r,t,e)}),r.on("click",function(){i._addMarker(r,t,e)})},_addMarker:function(t,e,i){var n=L.divIcon({className:"marker-icon"});t.setIcon(n),t.off("dragstart"),t.off("click");var r=t.getLatLng(),a=this._poly._latlngs[0],o=e._index+1;a.splice(o,0,r),t._origLatLng=a[o],this._markers.splice(o,0,t);for(var s=0;s<this._markers.length;s++)this._markers[s]._index=s;this._createMiddleMarker(e,t),this._createMiddleMarker(t,i)},_removeMarker:function(t){var e=t.target;if(void 0!==e._index){var i=this._poly._latlngs[0],n=e._index;i.splice(n,1),this._poly.redraw(),this._markerGroup.removeLayer(e._middleMarkerLeft),this._markerGroup.removeLayer(e._middleMarkerRight),this._markerGroup.removeLayer(e);var r=0>n-1?this._markers.length-1:n-1,a=n+1>=this._markers.length?0:n+1,o=this._markers[r],s=this._markers[a];this._createMiddleMarker(o,s),this._markers.splice(n,1);for(var l=0;l<this._markers.length;l++)this._markers[l]._index=l;this._fireEdit()}},_onMarkerDrag:function(t){var e=t.target,i=e._index+1>=this._markers.length?0:e._index+1,n=e._index-1<0?this._markers.length-1:e._index-1;L.extend(e._origLatLng,e._latlng),this._poly.redraw();var r=this._calcMiddleLatLng(e,this._markers[i]);e._middleMarkerRight.setLatLng(r);var a=this._calcMiddleLatLng(e,this._markers[n]);e._middleMarkerLeft.setLatLng(a)},_onMarkerDragEnd:function(t){t.target;this._fireEdit()},_fireEdit:function(){this._poly.edited=!0,this._poly.fireEvent("pm:edit")},_calcMiddleLatLng:function(t,e){var i=this._poly._map,n=i.project(t.getLatLng()),r=i.project(e.getLatLng()),a=i.unproject(n._add(r)._divideBy(2));return a}}),L.PM.Edit.LayerGroup=L.Class.extend({initialize:function(t){this._layerGroup=t,this._layers=t.getLayers();for(var e=0;e<this._layers.length;e++)this._layers[e].on("pm:edit",this._fireEdit,this)},_fireEdit:function(){this._layerGroup.fireEvent("pm:edit")},toggleEdit:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.toggleEdit()},enable:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.enable()},disable:function(){for(var t=0;t<this._layers.length;t++)this._layers[t].pm.disable()},enabled:function(){for(var t=!1,e=0;e<this._layers.length&&!(t=this._layers[e].pm.enabled());e++);return t}});